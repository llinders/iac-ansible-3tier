# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
    config.vm.box = "generic/ubuntu2004"
    config.ssh.insert_key = false
    config.vm.synced_folder('.', '/vagrant', disabled: true)
  
    config.vm.provider :vmware_esxi do |esxi|
        esxi.esxi_hostname = '10.0.0.200'
        esxi.esxi_username = 'root'
        esxi.esxi_password = '5Vhj2WzmGE45cxp'
        esxi.esxi_virtual_network = ['VM Network']
        esxi.guest_memsize = '2048'
        esxi.guest_numvcpus = '1'
    end

    # Load balancer
    config.vm.define "lb" do |lb|
        lb.vm.hostname = "lb.iac.net"
        lb.vm.define "lb.iac.net"
        lb.vm.network :private_network, ip: "{{ loadbalancer_ip }}"

        lb.vm.provision "ansible" do |ansible|
            ansible.playbook = "playbook-common.yml"
            ansible.extra_vars = {
                ansible_user: 'vagrant',
                ansible_ssh_private_key_file: "~/.vagrant.d/insecure_private_key"
            }
        end
    end
{% for webserver in webservers %}
    # Apache webserver {{ loop.index }}
    config.vm.define "www{{ loop.index }}" do |web|
        web.vm.hostname = "web{{ loop.index }}.iac.net"
        web.vm.define "web{{loop.index }}.iac.net"
        web.vm.network :private_network, ip: "{{ webserver }}"
    
        web.vm.provision "ansible" do |ansible|
            ansible.playbook = "playbook-common.yml"
            ansible.extra_vars = {
            ansible_user: 'vagrant',
            ansible_ssh_private_key_file: "~/.vagrant.d/insecure_private_key"
            }
        end
    end
{% endfor %}
    # Database
    config.vm.define "db" do |db|
        db.vm.hostname = "db.iac.net"
        db.vm.define "db.iac.net"
        db.vm.network :private_network, ip: "{{ database_ip }}"

        db.vm.provision "ansible" do |ansible|
            ansible.playbook = "playbook-common.yml"
            ansible.extra_vars = {
                ansible_user: 'vagrant',
                ansible_ssh_private_key_file: "~/.vagrant.d/insecure_private_key"
            }
        end
    end
end